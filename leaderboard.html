<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="assets/logo.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard - Don Golf</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
  <div class="page-wrapper">
    <div class="container">
      <a href="index.html">
        <img src="assets/logo.png" alt="Don Golf Logo" class="logo" />
      </a>
      <h1 class="headline">Don Golf Leaderboard</h1>
    </div>

    <!-- Simple explainer + primary CTA (uses existing styles) -->
    <section class="how-it-works" id="leaderboard-cta">
      <h2>Scan. Claim. Compete.</h2>
      <p>These are the golfers in the mix. Tags changing hands and ranks shifting in real time.</p>
      <p>Don’t just watch. Grab a tag and claim your spot.</p>
      <a href="buy.html" class="button">Buy Tags</a>
    </section>

    <div class="leaderboard-iframe-wrapper">
      <div id="leaderboard" class="leaderboard-card"></div>
    </div>


  <!-- Blog Promo Section -->
  <section class="blog-promo">
    <p>
      Hey, did you know we also run a blog where we cover golf products, gadgets, and other fun topics?
      Go check it out for some good fun.
    </p>
    <a href="blog/index.html" class="blog-button">Visit Blog</a>
  </section>

  <!-- Floating Instagram Button -->
  <a class="social-link" href="https://www.instagram.com/thedongolfer/" target="_blank" aria-label="Follow us on Instagram">
    <i class="fa-brands fa-instagram"></i>
  </a>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // ====== Config ======
  const CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcpWn8GTDSMAok7uw40yM7j8mDRkD67DQCkauSuEnzQM8rgL8YMWQEfsOEZkbdXH1HPTkgkQfmvKsk/pub?gid=833273816&single=true&output=csv';

  // We normalize headers to lowercase (with trim), so map in lowercase:
  const COLS = {
    tag: 'tag #',
    name: 'name',
    location: 'location',
  };

  // ====== Data fetch & parse ======
  function fetchCSV() {
    const url = CSV_URL + '&_ts=' + Date.now(); // cache-bust
    return new Promise((resolve) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: (h) => h.replace(/^\uFEFF/, '').trim().toLowerCase(),
        complete: (res) => resolve(res.data),
      });
    });
  }

  // ====== State ======
  let rows = [];
  let view = [];
  let page = 0;
  const pageSize = 25;
  let sortKey = 'tag';
  let sortDir = 'asc';
  let q = '';

  // Cache DOM refs so we only rebuild tbody/meta on updates
  const el = {};

  function normalize(r) {
    return {
      tag: r[COLS.tag] ?? '',
      name: r[COLS.name] ?? '',
      location: r[COLS.location] ?? '',
    };
  }

  function naturalKey(val) {
    // helps sort tags like "001" or "#12" naturally
    const num = String(val).replace(/[^\d]/g, '');
    return num.length ? [0, parseInt(num, 10)] : [1, String(val).toLowerCase()];
  }

  function updateView() {
    const needle = q.trim().toLowerCase();

    view = !needle
      ? [...rows]
      : rows.filter((r) =>
          (r.tag || '').toLowerCase().includes(needle) ||
          (r.name || '').toLowerCase().includes(needle) ||
          (r.location || '').toLowerCase().includes(needle)
        );

    view.sort((a, b) => {
      const A = a[sortKey] ?? '';
      const B = b[sortKey] ?? '';
      // natural-ish sorting for tag values
      if (sortKey === 'tag') {
        const [aT, aN] = naturalKey(A);
        const [bT, bN] = naturalKey(B);
        const cmp = aT - bT || (aN < bN ? -1 : aN > bN ? 1 : 0);
        return sortDir === 'asc' ? cmp : -cmp;
      }
      const aS = String(A).toLowerCase();
      const bS = String(B).toLowerCase();
      const aNum = +aS, bNum = +bS;
      if (!isNaN(aNum) && !isNaN(bNum)) {
        return sortDir === 'asc' ? aNum - bNum : bNum - aNum;
      }
      return sortDir === 'asc' ? aS.localeCompare(bS) : bS.localeCompare(aS);
    });
  }

  function renderBody() {
    const start = page * pageSize;
    const slice = view.slice(start, start + pageSize);

    el.tbody.innerHTML = '';
    for (const r of slice) {
      const tr = document.createElement('tr');
      tr.className = 'dg-tr';
      tr.innerHTML = `
        <td class="dg-td"><span class="dg-tagcode">${r.tag}</span></td>
        <td class="dg-td">${r.name || ''}</td>
        <td class="dg-td dg-col-location">${r.location || ''}</td>
      `;
      el.tbody.appendChild(tr);
    }

    const end = Math.min(start + pageSize, view.length);
    el.meta.textContent = `${view.length} players · showing ${view.length ? start + 1 : 0}-${end}`;
    el.prev.disabled = page === 0;
    el.next.disabled = end >= view.length;
  }

  function buildUI() {
    const root = document.getElementById('leaderboard');

    // Controls (build once)
    const controls = document.createElement('div');
    controls.className = 'dg-controls';
    controls.innerHTML = `
      <input id="dg-search" class="dg-search" type="search" placeholder="Search tag, name, location…" />
      <div class="dg-pager">
        <span class="dg-meta" id="dg-meta"></span>
        <button id="dg-prev" class="dg-btn">Prev</button>
        <button id="dg-next" class="dg-btn">Next</button>
      </div>
    `;
    root.appendChild(controls);

    // Table shell (build once)
    const table = document.createElement('table');
    table.className = 'dg-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th class="dg-th" data-k="tag">Tag #</th>
          <th class="dg-th" data-k="name">Name</th>
          <th class="dg-th dg-col-location" data-k="location">Location</th>
        </tr>
      </thead>
      <tbody id="dg-body"></tbody>
    `;
    root.appendChild(table);

    // Cache refs
    el.search = controls.querySelector('#dg-search');
    el.meta   = controls.querySelector('#dg-meta');
    el.prev   = controls.querySelector('#dg-prev');
    el.next   = controls.querySelector('#dg-next');
    el.tbody  = table.querySelector('#dg-body');
    el.headers= table.querySelectorAll('.dg-th');

    // Wire once (keeps focus between updates)
    el.search.addEventListener('input', () => {
      q = el.search.value;
      page = 0;
      updateView();
      renderBody();
    });

    el.headers.forEach((th) => {
      th.addEventListener('click', () => {
        const k = th.dataset.k;
        sortDir = sortKey === k && sortDir === 'asc' ? 'desc' : 'asc';
        sortKey = k;
        updateView();
        renderBody();
      });
    });

    el.prev.addEventListener('click', () => {
      if (page > 0) { page--; renderBody(); }
    });
    el.next.addEventListener('click', () => {
      if ((page + 1) * pageSize < view.length) { page++; renderBody(); }
    });
  }

  async function init() {
    const data = await fetchCSV();
    rows = data.map(normalize);

    buildUI();          // build controls/table once
    updateView();       // compute filtered/sorted view
    renderBody();       // draw rows + meta

    // Auto-refresh every 60s without nuking focus or scroll
    setInterval(async () => {
      const fresh = await fetchCSV();
      rows = fresh.map(normalize);
      const searchPos = el.search.selectionStart; // preserve caret
      updateView();
      renderBody();
      // restore caret position if user is typing
      el.search.setSelectionRange(searchPos, searchPos);
      el.search.focus();
    }, 60000);
  }

  init();
</script>
</body>
</html>